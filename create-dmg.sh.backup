#!/bin/bash
set -e

# RSS Reader DMG Creation Script
# Creates a distributable DMG file

echo "ğŸ’¿ Creating DMG for RSS Reader..."

# Configuration
APP_NAME="RSS Reader"
VERSION="1.0.0"
BUILD_DIR=".build/release"
APP_BUNDLE="$BUILD_DIR/$APP_NAME.app"
DMG_NAME="RSSReader-$VERSION.dmg"
TEMP_DMG="RSSReader-temp.dmg"
VOLUME_NAME="RSS Reader $VERSION"

# Check if app bundle exists
if [ ! -d "$APP_BUNDLE" ]; then
    echo "âŒ App bundle not found. Run ./scripts/build-release.sh first."
    exit 1
fi

# Clean previous DMG
echo "ğŸ§¹ Cleaning previous DMG..."
rm -f "$BUILD_DIR/$DMG_NAME"
rm -f "$BUILD_DIR/$TEMP_DMG"

# Create temporary DMG
echo "ğŸ“¦ Creating temporary DMG..."
hdiutil create -srcfolder "$APP_BUNDLE" -volname "$VOLUME_NAME" \
    -fs HFS+ -fsargs "-c c=64,a=16,e=16" -format UDRW \
    "$BUILD_DIR/$TEMP_DMG"

# Mount the temporary DMG
echo "ğŸ”§ Mounting DMG..."
MOUNT_OUTPUT=$(hdiutil attach -readwrite -noverify -noautoopen "$BUILD_DIR/$TEMP_DMG")
MOUNT_DIR=$(echo "$MOUNT_OUTPUT" | grep -o '/Volumes/.*')

if [ -z "$MOUNT_DIR" ]; then
    echo "âŒ Failed to mount DMG"
    exit 1
fi

echo "Mounted at: $MOUNT_DIR"

# Add symbolic link to Applications folder
echo "ğŸ”— Creating Applications link..."
ln -s /Applications "$MOUNT_DIR/Applications"

# Set icon positions (optional, requires DS_Store file)
echo "ğŸ¨ Setting DMG appearance..."
# Note: For custom backgrounds and icon positions, you'd need to create
# a .DS_Store file with the desired layout. For now, we'll use default.

# Unmount
echo "ğŸ’¾ Finalizing DMG..."
hdiutil detach "$MOUNT_DIR" || hdiutil detach "$MOUNT_DIR" -force

# Convert to compressed DMG
echo "ğŸ—œï¸  Compressing DMG..."
hdiutil convert "$BUILD_DIR/$TEMP_DMG" -format UDZO -o "$BUILD_DIR/$DMG_NAME"

# Clean up
rm -f "$BUILD_DIR/$TEMP_DMG"

# Display info
echo ""
echo "âœ¨ DMG created successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "DMG: $BUILD_DIR/$DMG_NAME"
echo "Size: $(du -h "$BUILD_DIR/$DMG_NAME" | cut -f1)"
echo ""
echo "You can now distribute this DMG file."
echo "Users can drag the app to their Applications folder."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

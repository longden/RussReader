#!/bin/bash
set -e

# RSS Reader Build Script (Stripped Symbols)
# Builds with symbol stripping for additional obfuscation

echo "๐ Building RSS Reader (symbol stripped)..."

# Configuration
APP_NAME="RSS Reader"
BUNDLE_ID="com.rssreader.menubar"
VERSION="1.0.0"
BUILD_DIR=".build/release"
APP_BUNDLE="$BUILD_DIR/$APP_NAME.app"
CONTENTS_DIR="$APP_BUNDLE/Contents"
MACOS_DIR="$CONTENTS_DIR/MacOS"
RESOURCES_DIR="$CONTENTS_DIR/Resources"

# Clean previous builds
echo "๐งน Cleaning previous builds..."
rm -rf "$APP_BUNDLE"

# Build release binary with optimizations
echo "๐จ Building release binary..."
swift build -c release \
    -Xswiftc -enforce-exclusivity=checked \
    -Xswiftc -O

# Create app bundle structure
echo "๐ฆ Creating app bundle..."
mkdir -p "$MACOS_DIR"
mkdir -p "$RESOURCES_DIR"

# Copy executable
echo "๐ Copying executable..."
cp "$BUILD_DIR/RSSReader" "$MACOS_DIR/RSSReader"

# Strip symbols for additional protection
echo "๐ Stripping debug symbols..."
strip -x "$MACOS_DIR/RSSReader"

# Copy resources
echo "๐จ Copying resources..."
cp Info.plist "$CONTENTS_DIR/Info.plist"
cp Sources/Resources/AppIcon.icns "$RESOURCES_DIR/AppIcon.icns"
if [ -f "Sources/Resources/Localizable.xcstrings" ]; then
    cp Sources/Resources/Localizable.xcstrings "$RESOURCES_DIR/"
fi

# Create PkgInfo
echo "APPL????" > "$CONTENTS_DIR/PkgInfo"

# Sign the app
echo "โ๏ธ  Signing app..."
codesign --force --deep --sign - --entitlements RSSReader.entitlements "$APP_BUNDLE"

# Verify the app
echo "โ Verifying app bundle..."
if [ -x "$MACOS_DIR/RSSReader" ]; then
    echo "โ Executable is valid"
else
    echo "โ Executable is not valid"
    exit 1
fi

# Display bundle info
ORIGINAL_SIZE=$(stat -f%z "$BUILD_DIR/RSSReader")
STRIPPED_SIZE=$(stat -f%z "$MACOS_DIR/RSSReader")
SAVED=$((ORIGINAL_SIZE - STRIPPED_SIZE))

echo ""
echo "โจ Build complete (symbol stripped)!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "App Bundle: $APP_BUNDLE"
echo "Version: $VERSION"
echo "Bundle ID: $BUNDLE_ID"
echo "Original size: $(numfmt --to=iec $ORIGINAL_SIZE 2>/dev/null || echo $ORIGINAL_SIZE bytes)"
echo "Stripped size: $(numfmt --to=iec $STRIPPED_SIZE 2>/dev/null || echo $STRIPPED_SIZE bytes)"
echo "Space saved: $(numfmt --to=iec $SAVED 2>/dev/null || echo $SAVED bytes)"
echo ""
echo "โ๏ธ  Debug symbols removed for better obfuscation"
echo "To run: open '$APP_BUNDLE'"
echo "To create DMG: ./scripts/create-dmg.sh"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
